#!/bin/sh

TestAndCreateDir() {
    if [ ! -d $1 ]; then
	#echo "Directory $1 does not exist. Creating it.";
        mkdir $1;
    fi
}


if test $# -ne 1
then
  echo "Usage: install-civs <settings-file>";
  exit 1;
fi

. $1 || exit 1

echo "Read settings file"

make gettimeofday

TestAndCreateDir $HTMLDIR;
TestAndCreateDir $CGIBINDIR;
TestAndCreateDir $CIVSDATADIR;
TestAndCreateDir $CIVSDATADIR/elections;

    for f in civs_create.html index.html public_elections.html proportional.html sec_priv.html style.css
    do
	#echo "copying $f to $HTMLDIR/$f"
	sed  -e 's|@PERL@|'$PERL'|' \
	     -e 's|@CGIBINDIR@|'$CGIBINDIR'|'\
	     -e 's|@THISHOST@|'$THISHOST'|' \
	     -e 's|@CIVSDATADIR@|'$CIVSDATADIR'|' \
	     -e 's|@CIVSBINURL@|'$CIVSBINURL'|' \
	     -e 's|@CIVSURL@|'$CIVSURL'|' \
	     -e 's|@SUPERVISOR@|'$SUPERVISOR'|' \
	     -e 's|@SMTPHOST@|'$SMTPHOST'|' \
	< $f > "${HTMLDIR}/$f"
    done

    for f in add_voters beatpath.pm civs_common.pm close control \
        create_election download_ballots election.pm mail.pm results \
	start_election vote
    do
	#echo "copying cgi-bin/$f"
	sed  -e 's|@PERL@|'$PERL'|' \
	     -e 's|@CGIBINDIR@|'$CGIBINDIR'|'\
	     -e 's|@THISHOST@|'$THISHOST'|' \
	     -e 's|@CIVSDATADIR@|'$CIVSDATADIR'|' \
	     -e 's|@CIVSBINURL@|'$CIVSBINURL'|' \
	     -e 's|@CIVSURL@|'$CIVSURL'|' \
	     -e 's|@SUPERVISOR@|'$SUPERVISOR'|' \
	     -e 's|@SMTPHOST@|'$SMTPHOST'|' \
	< "cgi-bin/$f" > "$CGIBINDIR/$f"
	chmod a+x "${CGIBINDIR}/$f";
    done

    if [ ! -s $CIVSDATADIR/private_host_id ]; then
	echo "*********************************************";
	echo "                 WARNING                     ";
	echo "*********************************************";
	echo "";
	echo "No private key exists for the server!";
	echo "";
	echo "You must create the file $CIVSDATADIR/private_host_id";
	echo "See the INSTALL file for more information.";
	echo "";
    fi

    touch $CIVSDATADIR/nonce_seed
    chmod ugo+w $CIVSDATADIR/nonce_seed
    cp gettimeofday $CIVSDATADIR/gettimeofday
    
echo "Install completed.  Check for any errors reported above.";
