#!@PERL@ -I@CGIBINDIR@

use CGI qw(:standard);
use Digest::MD5 qw(md5_hex);
use civs_common;
use DB_File;
use mail;

use Socket;
use IO::Handle;
use election;

LockElection;

$thisurl = $civs_bin_path."/add_voters";

$new_addresses = param('new_addresses');
$new_addresses_file = param('new_addresses_file');
while (<$new_addresses_file>) {
    $new_addresses .= $_;
}
@new_addresses = split /[\r\n]+/, $new_addresses;

HTML_Header("CIVS: Adding Voters");
CIVS_Header("Adding voters");

CheckControlKey;

if (!IsStarted || IsStopped) {
    print h1(Error), p("Sorry, voters can only be added to an election in progress.");
    exit 0;
}

print "<pre>\n";
GetPrivateHostID;
if (!($local_debug)) { ConnectMail; }

# Send all of the voters their keys

SendKeys(@new_addresses);

Send "quit";
close(SMTP);
print "Done.\n</pre>\n";

print p("<a href=\"$civs_bin_path/control?id=$election_id&key=$control_key\">Go back to election control</a>");

$num_new_voters = $#new_addresses + 1;
$edata{'num_auth'} += $num_new_voters;

print end_html();
Log("$num_new_voters new voters added to $title ($election_id)");
untie %edata;

UnlockElection;

exit 0;
