#!@PERL@ -I@CGIBINDIR@

use strict;
use warnings;

use civs_common;
use CGI qw(:standard);
use Digest::MD5 qw(md5_hex);
use DB_File;

use Socket;
use IO::Handle;
use election;

my $thisurl = $civs_bin_path."/add_voters";

my $new_addresses = param('new_addresses');
my $new_addresses_file = upload('new_addresses_file');
if (defined($new_addresses_file)) {
	while (<$new_addresses_file>) {
    	$new_addresses .= $_;
	}
}
my @new_addresses = split /[\r\n]+/, $new_addresses;

HTML_Header("CIVS: Adding Voters");
CIVS_Header("Adding voters");

my $control_key = param('key');    
CheckControlKey($control_key);
my $authorization_key = param('akey');
CheckAuthorizationKeyForAddingVoter($authorization_key);

if (!IsStarted || IsStopped) {
    print h1("Error"), p("Sorry, voters can only be added to an election in progress.");
    exit 0;
}

print "<pre>\n";
GetPrivateHostID;

# Send all of the voters their keys
my $num_added = SendKeys($authorization_key, \@new_addresses);

print "$num_added voter(s) added\n";
print "Done.\n</pre>\n";

my $url = "$civs_bin_path/control?id=$election_id&key=$control_key";
$url .= "&akey=$authorization_key" if defined($authorization_key);
print p("<a href=\"$url\">Go back to election control</a>");

$edata{'num_auth'} += $num_added;

print end_html();
Log("$num_auth new voters added to $title ($election_id)");

exit 0;
