#!@PERL@

use strict;
use warnings;

use lib '@CGIBINDIR@';
use civs_common;
use CGI qw(:standard);
use Digest::MD5 qw(md5_hex);
use DB_File;

use Socket;
use IO::Handle;

my $thisurl = $civs_bin_path."/close@PERLEXT@";

HTML_Header("CIVS: Stopping Election");
use election;

my $control_key = param('key');    

CIVS_Header("Stopping poll");

CheckElectionID;
CheckStarted;
CheckControlKey($control_key);
CheckNotStopped;

if (!sysopen(STOPPED, $stopped_file, O_CREAT|O_EXCL|O_RDWR)) {
    print h1("Error"), p("Was not able to stop the poll");
} else {
    print STOPPED "stopped\n"; close(STOPPED);
    Log("Poll $title ($election_id) stopped");
    print h1("Election stopped: $title");
    print p("The poll has been stopped. It was announced to end $election_end.");
    if ($restrict_results ne 'yes') {
	print p("<a href=\"http://$thishost$civs_bin_path/results@PERLEXT@?id=$election_id\">
	View poll results</a>");
    } else {
	print p('The poll results are now available to be viewed by authorized users.');
    }
}
print end_html();

$vdata{'last_vote_time'} = time();
$vdata{'close_time'} = localtime();

exit 0;
