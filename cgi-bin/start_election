#!@PERL@ -I@CGIBINDIR@

use IO::Handle;
use CGI qw(:standard);
use DB_File;
use Digest::MD5 qw(md5_hex);
use civs_common;
use mail;

HTML_Header("CIVS start election");
CIVS_Header('Start election');

use election;

$max_voters = 1000;

CheckElectionID;
CheckControlKey;

if (IsStarted) {
    print h1("Error");
    print p("This election has already been started"), end_html();
    exit 0;
}

StartElection;

print p('The election '.strong($title).' has been started.'.$cr);

print '<pre>'.$cr;

if ($#addresses > $max_voters) {
    print h2("Sorry, more than $max_voters voters are currently not allowed\n");
    exit 1;
}

SendKeys @addresses;

print p("<a href=\"$civs_bin_path/control?id=$election_id&key=$control_key\">Go back to election control</a>");

close(START);

# Destroy record of voter addresses so we can't
# figure out who voted for what.
$edata{'num_auth'} = $#addresses + 1;
$edata{'addresses'} = "";

print end_html();
untie %edata;

Log("Election $title ($election_id) started");

exit 0;
