#!@PERL@ -I@CGIBINDIR@

use strict;
use warnings;

use civs_common;
use IO::Handle;
use CGI qw(:standard);
use DB_File;
use Digest::MD5 qw(md5_hex);

HTML_Header("CIVS start election");
CIVS_Header('Start election');

use election;
my $max_voters = 1000;
my $control_key = param('key');   
my $authorization_key = param('authorization_key');

CheckElectionID;
CheckControlKey($control_key);
CheckAuthorizationKeyForAddingVoter($authorization_key);

if (IsStarted) {
    print h1("Error");
    print p("This election has already been started"), end_html();
    exit 0;
}

StartElection;

print p('The election '.strong($title).' has been started.'.$cr);

print '<pre>'.$cr;
if ($#addresses > $max_voters) {
    print h2("Sorry, more than $max_voters voters are currently not allowed\n");
    exit 1;
}

my $num_added = SendKeys($authorization_key, \@addresses);

print "Done.\n</pre>\n";

print p("<a href=\"$civs_bin_path/control?id=$election_id&key=$control_key&authorization_key=$authorization_key\">Go back to election control</a>");

# Destroy record of voter addresses so we can't
# figure out who voted for what.
$edata{'num_auth'} = $num_added;
$edata{'addresses'} = "";

print end_html();

Log("Election $title ($election_id) started");

exit 0;
